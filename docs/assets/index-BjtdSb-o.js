(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function o(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(s){if(s.ep)return;s.ep=!0;const n=o(s);fetch(s.href,n)}})();const W=["welcome","tutorial","menu","runner"],r={mode:"guided",participant:"",run:{task:null,queue:[],idx:0,startTime:0,rows:[]}};function T(e){W.forEach(t=>{const o=document.getElementById(t);o&&o.classList.toggle("active",t===e)}),window.scrollTo({top:0,behavior:"smooth"})}const C=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],P=Object.fromEntries(C.map((e,t)=>[e,t])),v=[["U","Unison"],["minor2","m2"],["major2","M2"],["minor3","m3"],["major3","M3"],["P4","P4"],["TT","TT"],["P5","P5"],["minor6","m6"],["major6","M6"],["minor7","m7"],["major7","M7"]],I=["1","b2","2","b3","3","4","TT","5","b6","6","b7","7"],E=e=>e.replace("#4","TT").replace("b5","TT");function y(e,{keyRoot:t=null,notes:o=[]}={}){if(!e)return;e.innerHTML="";const a=document.createElement("div");a.className="sn";for(let i=0;i<12;i++){const w=C[i],u=document.createElement("div");u.className="sn-row",u.dataset.pc=w;const f=document.createElement("div");f.className="sn-label",f.textContent=w,u.appendChild(f),a.appendChild(u)}if(e.appendChild(a),t){const i=document.createElement("div");i.className="sn-key",i.innerHTML=`<span class="root">1</span><span>Key: <b>${t}</b></span>`,e.appendChild(i)}const n=(e.clientHeight||360)/12,c=140,N=56;o.forEach((i,w)=>{const u=P[i.replace("♯","#").replace("♭","b")];if(u==null)return;const f=u*n+n/2-9,M=c+w*N,p=document.createElement("div");p.className="note",p.style.setProperty("--x",`${M}px`),p.style.setProperty("--y",`${f}px`),p.setAttribute("aria-label",`Note ${i}`),p.innerHTML='<span class="sr" aria-hidden="true"></span>',e.appendChild(p)})}function $(e,t="WSMN image or score rendering goes here"){e&&(e.innerHTML=`<div class="ws-placeholder">${t}</div>`)}const q={AS:[{id:"AS001",pitches:["F","A"],answer:"major3"},{id:"AS002",pitches:["C","G"],answer:"P5"},{id:"AS003",pitches:["E","F"],answer:"minor2"}],AW:[{id:"AW001",img:"assets/AW/aw_001.png",answer:"major3"},{id:"AW002",img:"assets/AW/aw_002.png",answer:"P5"},{id:"AW003",img:"assets/AW/aw_003.png",answer:"minor2"}],BS:[{id:"BS001",key:"Ab",pitch:"Db",answer:"4"},{id:"BS002",key:"E",pitch:"G",answer:"b3"},{id:"BS003",key:"C",pitch:"F#",answer:"#4"}],BW:[{id:"BW001",img:"assets/BW/bw_001.png",answer:"4"},{id:"BW002",img:"assets/BW/bw_002.png",answer:"b3"},{id:"BW003",img:"assets/BW/bw_003.png",answer:"TT"}]},D=e=>e.map(t=>[Math.random(),t]).sort((t,o)=>t[0]-o[0]).map(t=>t[1]),l=(e,t=document)=>t.querySelector(e),A=l("#answerPad"),d=l("#feedback"),j=l("#progress"),_=l("#timer"),F=l("#displayKind"),O=l("#taskLabel"),k=l("#taskCanvas"),g=l("#nextBtn");let b=null,x=0;function R(){L(),x=performance.now(),b=setInterval(()=>{const e=(performance.now()-x)/1e3;_.textContent=(Math.round(e*100)/100).toFixed(2)+"s"},50)}function L(){b&&(clearInterval(b),b=null)}function H(e){A.innerHTML="";const o=e==="AS"||e==="AW"?v:I.map(a=>[a,a]);for(const[a,s]of o){const n=document.createElement("button");n.className="opt",n.type="button",n.textContent=s,n.dataset.val=a,n.addEventListener("click",()=>U(a)),A.appendChild(n)}}function G(e,t){r.participant=t||"",r.run.task=e,r.run.queue=D(q[e].slice()),r.run.idx=0,r.run.rows=[],g.disabled=!0,d.textContent="",O.textContent=e==="AS"||e==="AW"?"Interval":"Scale Degree",F.textContent=e==="AS"||e==="BS"?"Student Notation":"WSMN",H(e),B()}function B(){const e=r.run.queue[r.run.idx];j.textContent=`${r.run.idx+1}/${r.run.queue.length}`,g.disabled=!0,d.className="feedback",d.textContent="",r.run.task==="AS"?y(k,{keyRoot:null,notes:e.pitches}):r.run.task==="BS"?y(k,{keyRoot:e.key,notes:[e.pitch]}):$(k),r.run.startTime=performance.now(),R()}function S(e){const t=v.find(o=>o[0]===e);return t?t[1]:e}function U(e){const t=performance.now()-r.run.startTime,o=r.run.queue[r.run.idx],a=r.run.task==="BS"||r.run.task==="BW",s=a?E(e):e,n=a?E(o.answer):o.answer,c=s===n;d.textContent=c?"Correct":`Incorrect — your answer: ${S(s)}; correct: ${S(n)}`,d.className="feedback "+(c?"good":"bad"),g.disabled=!1,r.run.rows.push({participant:r.participant,task:r.run.task,questionID:o.id,userAnswer:s,answer:n,accuracy:c?1:0,responseTimeMs:Math.round(t)})}function K(){const e=r.run.queue[r.run.idx];r.run.rows.push({participant:r.participant,task:r.run.task,questionID:e.id,userAnswer:"SKIP",answer:e.answer,accuracy:0,responseTimeMs:0}),d.className="feedback bad",d.textContent="Skipped. Marked as incorrect.",g.disabled=!1}function V(){L(),r.run.idx<r.run.queue.length-1?(r.run.idx++,B()):(d.className="feedback good",d.textContent="Task complete. Export data or choose another task.")}function z(e){const t=["participant","task","questionID","userAnswer","answer","accuracy","responseTimeMs"],o=[t.join(",")];for(const a of e){const n=t.map(c=>String(a[c]??"")).map(c=>/[",\n]/.test(c)?`"${c.replaceAll('"','""')}"`:c);o.push(n.join(","))}return o.join(`
`)}function X(e,t,o="text/csv;charset=utf-8;"){const a=new Blob([t],{type:o}),s=URL.createObjectURL(a),n=document.createElement("a");n.href=s,n.download=e,n.click(),URL.revokeObjectURL(s)}const m=(e,t=document)=>t.querySelector(e),h=(e,t=document)=>[...t.querySelectorAll(e)];h("[data-nav]").forEach(e=>e.addEventListener("click",()=>T(e.dataset.nav)));const J=m("#modeChip");h("[data-mode]").forEach(e=>e.addEventListener("click",()=>{r.mode=e.dataset.mode,J.textContent=r.mode==="guided"?"Guided":"Free-run",h("[data-mode]").forEach(t=>t.classList.remove("primary")),e.classList.add("primary")}));const Q=m("#tutCanvas"),Y={keyRoot:"Ab",notes:["F","A"]},Z="A",ee="M3";function te(){y(Q,Y)}te();h("[data-check]").forEach(e=>{e.addEventListener("click",()=>{e.disabled=!0;const t=document.createElement("div");t.className="chip",t.textContent=e.dataset.check==="pitch"?`Answer: ${Z}`:`Answer: ${ee}`,e.after(t)})});const ne=m("#pid");h("[data-start]").forEach(e=>e.addEventListener("click",()=>{G(e.dataset.start,ne.value.trim()),T("runner")}));m("#skipBtn").addEventListener("click",()=>K());m("#nextBtn").addEventListener("click",()=>V());const re=m("#exportBtn");re.addEventListener("click",()=>{const e=r.run.rows||[];if(!e.length){alert("No data to export yet. Run a task first.");return}const t=z(e);X(`sn_results_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.csv`,t)});
